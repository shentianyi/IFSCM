<% if demands%>
<%if demands.items.count>0%>
<div class="tableview" id='tableview'>
     <table class="upData" id="<%= demands.key%>">
          <tr class="lineone">
               <th>&nbsp;</th>
               <th>供应商号</th>
               <th>零件号</th>
               <th>文件日期</th>
               <th>要货日期</th>
               <th>数量</th>
               <th>预测类型</th>
               <th>变动量</th>
          </tr>
          <tr class="divide" style="display: none">
               <th class="nordvd">&nbsp;</th>
               <th class="nordvd"></th>
               <th class="nordvd"></th>
               <th class="nordvd"></th>
               <th class="nordvd"></th>
               <th class="nordvd"></th>
               <th class="nordvd"></th>
               <th class="lastdvd"></th>
          </tr>
          <% i=0
          demands.items.each do |item|
          i+=1
          thisLineWidth=lastLineWidth=nil
          if item.rate.to_i>=0
          thisLineWidth=100
          lastLineWidth= item.oldamount.to_i>0 ? 100/(1+item.rate.to_f/100) : 0
          else
          thisLineWidth=100/(1-item.rate.to_f/100)
          lastLineWidth=item.oldamount.to_i>0 ? 100 : 0
          end
          %>
          <tr class="norline" id="<%= item.key%>">
               <th class="no-type-change"><%= i%></th>
               <th class="no-type-change" id='supplierNr'><%= item.supplierNr%></th>
               <th class="no-type-change" id="partNr"><%= item.cpartNr%></th>
               <th class="no-type-change" id="filedate"><%= item.filedate%></th>
               <th class="no-type-change" id="date"><%= item.date%></th>
               <th class="no-auto-click-bind" id="amount" ondblclick="reset_demand_amount(this);"><%= item.amount%></th>
               <th class="no-type-change" id="type"><%= item.type%></th>
               <th class='no-type-change'>
               <div class="forcastcompare">
                    <div class="lineforcast">
                         <span class="percentage"> <%= item.rate.to_i.abs %>% </span>
                         <img src="/assets/<%= (item.rate.to_i>=0 ? 'arrup' : 'arrdown')%>.png" class='percentageImg' />
                    </div>
                    <div class="lineforcast">
                         <span class="fnumbers">本次预测：<span id="this_demand_amount"><%= item.amount %></span></span>
                         <div class="forcastbaseline">
                              <div class="partline" style="width:<%= thisLineWidth%>%" id='thisLineWidthDiv'></div>
                              <div class="gap"></div>
                         </div>
                    </div>
                    <div class="lineforcast">
                         <span class="fnumbers">上次预测：<%= item.oldamount %></span>
                         <div class="forcastbaseline">
                              <div class="partline" style="width:<%= lastLineWidth%>%" id='lastLineWidthDiv'></div>
                         </div>
                    </div>
               </div></th>
          </tr>
          <%end%>
     </table>
     <!-- pager -->
     <div class="pagers">
     <%=bri_pager options={:class=>"pagination",:pages=>@totalPages,:current=>@currentPage,:action=>'get_upfile_demands',:target=>demands.key}%>
     </div> 
     
</div>
<%else%>
<p>
     文件中无预测
</p>>
<%end%>
<%else%>
 <p>
      文件内容获取错误
 </p>
<%end%>
<script type="text/javascript">
     function send_demand_batchFile() {
       $.ajax({
            url: '../demander/send_demand',
               data:{
                    'batchFileId' : $('#batchFileId').val()
               },
               dataType:'json',
               type:'post',
               success:function(data){
                    if(data.result){
                         alert(data.content);
                         window_redirect("../demander/demand_upload",1000);
                    }else{
                         alert(data.content);
                    }
               }
       });
     }
     // ws: rest demand amount -- now just reset the amount of demand
function reset_demand_amount(obj) {
     var tag = obj.firstChild.tagName;
     if( typeof (tag) != "undefined" && (tag == "INPUT" || tag == "TEXTAREA"))
          return;
     var val = obj.innerHTML;
     var txt = document.createElement("INPUT");
     txt.value = val;
     txt.style.background = "#FFC";
     txt.style.width = obj.offsetWidth + "px";
     obj.innerHTML = "";
     obj.appendChild(txt);
     txt.focus();
     txt.onblur = function(e) {
          if(txt.value.length == 0)
               txt.value = val;
          obj.innerHTML = txt.value;
          if(val != txt.value) {
               if(notNegaNum(txt.value)) {
                    var demand = $(obj).parent();
                    update_demand(demand, function(data) {
                         if(data != null) {
                              if(data.result) {
                                   var de = data.object;
                                   if(de.vali) {
                                        demand.find('#this_demand_amount').text(de.amount);
                                        demand.find('.percentage').text(Math.abs(Math.round(de.rate)) + '%');
                                        // gen amount bar & reset img
                                        var rate = parseFloat(de.rate);
                                        if(rate >= 0) {
                                             demand.find('#thisLineWidthDiv').css('width', '100%');
                                             if(parseInt(de.oldamount) > 0)
                                                  demand.find('#lastLineWidthDiv').css('width', '' + (100/(1+rate/100)) + '%');
                                             else
                                                  demand.find('#lastLineWidthDiv').css('width', '0%');
                                             demand.find('.percentageImg').attr('src', '/assets/arrup.png');
                                        } else {
                                             demand.find('#thisLineWidthDiv').css('width', '' + (100/(1-rate/100)) + '%');
                                             demand.find('#lastLineWidthDiv').css('width', '100%');
                                             demand.find('.percentageImg').attr('src', '/assets/arrdown.png');
                                        }
                                        //.....
                                   } else {
                                        alert(jQuery.parseJSON(de.msg)[0]);
                                   }
                              } else {
                                   alert(data.content);
                              }
                         } else {
                              alert('无法找到DOM');
                         }
                    });
               } else {
                    alert('请填入非负整数预测量！');
               }
          }
     }
}
</script>

